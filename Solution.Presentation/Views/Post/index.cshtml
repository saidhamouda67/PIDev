@model Solution.Presentation.Models.Post.PostIndexModel
@using Microsoft.AspNet.Identity

<div>
    @if (@Model.CurrentUserId != null)
    {
        if (@Model.CurrentUserId == @Model.AuthorId)
        {
            <a href="/Post/Update?id=@Model.Id" class="btn btn-dark" style="float:right;">update</a>

            <a href="/Post/Delete?id=@Model.Id" class="btn btn-dark" style="float:right;">delete</a>
        }
    }


</div>


<style>

    .comment-wrapper .panel-body {
        max-height: 100%;
        width: 100%;
        overflow: auto;
    }

    .comment-wrapper .media-list .media img {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        border: 2px solid #e5e7e8;
    }

    .comment-wrapper .media-list .media {
        border-bottom: 1px dashed #efefef;
        margin-bottom: 25px;
    }
</style>

<!-- Blog Details Section Begin -->
<section class="blog-details spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="blog-details-inner">
                    <div class="col-lg-6 pull-right">

                        <div class="blog-detail-title">
                            <h2>@Model.Title</h2>
                            <p>@Model.AuthorName <span>- @Model.Created.ToString()</span><span id="NumOfComments"></span></p>
                        </div>
                        <div class="blog-large-pic">
                            <img src="@Url.Content(@Model.ImageUrl)" style="max-height:500px;max-width:350px;" alt="">
                        </div>

                        <div class="blog-quote">
                            <p>
                                @Model.PostContennt
                            </p>
                        </div>

                        <div class="tag-share">
                            <div class="details-tag">
                                <ul>
                                    <li><i class="fa fa-tags"></i></li>
                                    <li>Travel</li>
                                    <li>Beauty</li>
                                    <li>Fashion</li>
                                </ul>
                            </div>
                            <div class="blog-share">
                                <span>Share:</span>
                                <div class="social-links">
                                    <a href="#"><i class="fa fa-facebook"></i></a>
                                    <a href="#"><i class="fa fa-twitter"></i></a>
                                    <a href="#"><i class="fa fa-google-plus"></i></a>
                                    <a href="#"><i class="fa fa-instagram"></i></a>
                                    <a href="#"><i class="fa fa-youtube-play"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row bootstrap snippets mt-lg-5">
                        <div class="col-lg-12 col-md-offset-2 col-sm-12">
                            <div class="comment-wrapper">
                                <div class="panel panel-info">
                                    <div class="panel-heading">
                                        Comment panel
                                    </div>
                                    <div class="panel-body">
                                        @if (User.Identity.IsAuthenticated)
                                        {
                                            if (@Model.isCurrentUserEmailConfirmed)
                                            {
                                                <textarea class="form-control" id="comment" placeholder="write a comment..." rows="3"></textarea>
                                                <br>
                                                <button type="button" class="site-btn pull-right" onclick="testting()" id="buttonComment">Comment</button>
                                                <div class="clearfix"></div>
                                                <hr>
                                            }
                                        }
                                        <ul class="media-list" id="CommentsSection">
                                            <li class="media">
                                                <a href="#" class="pull-left">
                                                    <img src="https://bootdey.com/img/Content/user_1.jpg" alt="" class="img-circle">
                                                </a>
                                                <div class="media-body">
                                                    <span class="text-muted pull-right">
                                                        <small class="text-muted">30 min ago</small>
                                                    </span>
                                                    <strong class="text-success">hehehe</strong>
                                                    <p>
                                                        Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                                                        Lorem ipsum dolor sit amet, <a href="#">#consecteturadipiscing </a>.
                                                        Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                                                        Lorem ipsum dolor sit amet, <a href="#">#consecteturadipiscing </a>.
                                                        Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                                                        Lorem ipsum dolor sit amet, <a href="#">#consecteturadipiscing </a>.
                                                    </p>
                                                </div>
                                            </li>
                                            <li class="media">
                                                <a href="#" class="pull-left">
                                                    <img src="https://bootdey.com/img/Content/user_1.jpg" alt="" class="img-circle">
                                                </a>
                                                <div class="media-body">
                                                    <span class="text-muted pull-right">
                                                        <small class="text-muted">30 min ago</small>
                                                    </span>
                                                    <strong class="text-success">hehehehee</strong>
                                                    <p>
                                                        Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                                                        Lorem ipsum dolor sit amet, <a href="#">#consecteturadipiscing </a>.
                                                    </p>
                                                </div>
                                            </li>
                                            <li class="media">
                                                <a href="#" class="pull-left">
                                                    <img src="https://bootdey.com/img/Content/user_1.jpg" alt="" class="img-circle">
                                                </a>
                                                <div class="media-body">
                                                    <span class="text-muted pull-right">
                                                        <small class="text-muted">30 min ago</small>
                                                    </span>
                                                    <strong class="text-success">hehehehee</strong>
                                                    <p>
                                                        Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                                                        Lorem ipsum dolor sit amet, <a href="#">#consecteturadipiscing </a>.
                                                    </p>
                                                </div>
                                            </li>
                                            <li class="media">
                                                <a href="#" class="pull-left">
                                                    <img src="https://bootdey.com/img/Content/user_1.jpg" alt="" class="img-circle">
                                                </a>
                                                <div class="media-body">
                                                    <span class="text-muted pull-right">
                                                        <small class="text-muted">30 min ago</small>
                                                    </span>
                                                    <strong class="text-success">hehehehee</strong>
                                                    <p>
                                                        Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                                                        Lorem ipsum dolor sit amet, <a href="#">#consecteturadipiscing </a>.
                                                    </p>
                                                </div>
                                            </li>
                                            <li class="media">
                                                <a href="#" class="pull-left">
                                                    <img src="https://bootdey.com/img/Content/user_2.jpg" alt="" class="img-circle">
                                                </a>
                                                <div class="media-body">
                                                    <span class="text-muted pull-right">
                                                        <small class="text-muted">30 min ago</small>
                                                    </span>
                                                    <strong class="text-success">LaurenceCorreil</strong>
                                                    <p>
                                                        Lorem ipsum dolor sit amet, consectetur adipiscing elit.
                                                        Lorem ipsum dolor <a href="#">#ipsumdolor </a>adipiscing elit.
                                                    </p>
                                                </div>
                                            </li>
                                            <li class="media">
                                                <a href="#" class="pull-left">
                                                    <img src="https://bootdey.com/img/Content/user_3.jpg" alt="" class="img-circle">
                                                </a>
                                                <div class="media-body">
                                                    <span class="text-muted pull-right">
                                                        <small class="text-muted">30 min ago</small>
                                                    </span>
                                                    <strong class="text-success">JohnNida</strong>
                                                    <p>
                                                        Lorem ipsum dolor <a href="#">#sitamet</a> sit amet, consectetur adipiscing elit.
                                                    </p>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                </div>
            </div>
        </div>
        <!-- Button trigger modal -->
        <!-- Modal -->
        <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle">Modifier Commentaire</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="message-text" class="col-form-label">Commentaire</label>
                            <textarea class="form-control" id="ModifiedComment"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                        <button type="button" class="btn btn-primary" id="ModifierComment" data-dismiss="modal">Mofifier</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="DeleteModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle">Supprimer Commentaire</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                       <h6 class="modal-title" id="exampleModalLongTitle">Are you sure you want to delete this comment !!</h6>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                        <button type="button" class="btn btn-primary" id="DeleteComment" data-dismiss="modal">Confirmer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        var number = 0;
        var NumOfComments = 0;
        var SelectedCommentId = null;
        $("#comment").keypress((event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                testting();
            }
        })
        const affectCommentIdToSelectedCommentId = (id,replyContent) => {
            SelectedCommentId = id;

            $("#ModifiedComment").val(replyContent)
        }

        $("#NumOfComments i").remove();
        $("#ModifierComment").click(async function () {
            const commentaire = $.trim($("#ModifiedComment").val());
            const userId = '@User.Identity.GetUserId()';
            const postId = '@Model.Id';
            const commentId = SelectedCommentId;
            console.log(typeof(commentId))
            var EditedComment = {
                Id: commentId,
                Content: commentaire,
                UserId: userId,
                PostId:postId
            }
            console.log(EditedComment)
                var result = await $.ajax({
                   type: 'POST',
                   url: '@Url.Action("UpdateReply")',
                   data: '{Reply: ' + JSON.stringify(EditedComment) + '}',
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {
                        console.log(data);
                       LoadComments();
                   },
                   error: function (error) {
                       console.log(error);
                   }
               })
        })
        LoadComments();
        async function testting() {
                const commentaire=$.trim($("#comment").val());
                const postId = '@Model.Id';
         
               if (commentaire == "" ) {
                   alert('comment is vide!!');
                   return;
               }
               var  Reply = {};
               Reply.PostId = postId;
               Reply.ReplyContent = commentaire;
            console.log(JSON.stringify(Reply));
            console.log("avaaanti");
               var result = await $.ajax({
                   type: 'POST',
                   url: '@Url.Action("AddReply")',
                   data: '{Reply: ' + JSON.stringify(Reply) + '}',
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                   success: function (data) {
                       LoadComments();
                   },
                   error: function (error) {
                       console.log(error);
                   }
               })
            $("#comment").val("");
        }
        $("#DeleteComment").click(async function (){
            var Reply = {
                Id: SelectedCommentId
            }
            console.log(Reply);
            var result = await $.ajax({
                   type: 'POST',
                   url: '@Url.Action("DeleteComment")',
                   data: '{Reply: ' + JSON.stringify(Reply) + '}',
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                success: function (data) {
                    console.log(data);
                       LoadComments();
                   },
                   error: function (error) {
                       console.log(error);
                   }
               })
        });

        async function LoadComments() {
                           $("#CommentsSection li").remove();
                    $("#NumOfComments i").remove();

                const postId = '@Model.Id';
        
              
               var  Post = {};
            Post.Id = postId;
            var isItTheCurrentUser = null;
            var userAuthenticated = '@User.Identity.IsAuthenticated';
            userAuthenticated = (userAuthenticated.toLowerCase() === 'true');
            console.log(userAuthenticated)

            if (userAuthenticated)
                isItTheCurrentUser = '@User.Identity.GetUserId()';
            console.log(isItTheCurrentUser)
            const affectLidToButton = (Lid, userId, replyContent) => {
                var buttonString="<button class='btn btn-dark mr-2 pull-right'"
                    + " data-toggle='modal' onclick = 'affectCommentIdToSelectedCommentId(" + Lid+",\""+replyContent + "\")'"
                    + "data-target='#exampleModalCenter' > edit</button >"
                    + "<button class='btn btn-dark mr-2 pull-right' data-toggle='modal'data-target='#DeleteModal'  onclick = 'affectCommentIdToSelectedCommentId(" + Lid+",\"\")'>delete</button>";
                return (isItTheCurrentUser == userId) ?buttonString : "";
            }
                var result = await $.ajax({
                   type: 'POST',
                   url: '@Url.Action("getReplies")',
                   data: '{Post: ' + JSON.stringify(Post) + '}',
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                   success: function (data) {
                       $.each(data, function (i, item) {
                           var str = String(item.Created);
                           var res = Number(str.substring(6, str.length - 2))
                           var dateString = String(new Date(res));
                           dateString = dateString.substring(0, dateString.length - 42)
                           
                           var lastImg = String(item.AuthorImageUrl).replace("~","")
                           var row = "<li class='media'>"
                               + " <a href='#' class='pull-left'>"
                               + "<img src='"+lastImg+"'  class='img-circle'>"
                               + " </a>"
                               + " <div class='media-body'>"
                               + "  <span class='text-muted pull-right'>"
                               + " <small class='text-muted'>" + dateString + "</small>"
                               + " </span>"
                               + " <strong class='text-success'>" + item.AuthorName + "</strong>"
                               + "<p>  " + item.ReplyContent + "   </p>"
                               + affectLidToButton(item.Id, item.AuthorId, item.ReplyContent) + "</div>"
                               + "</li>";
                           $("#CommentsSection").append(row);
                       });
                       NumOfComments = data.length;
                       var numCommentsSection = "<i class='fa fa-reply'>"+NumOfComments+"</i>";
                       $("#NumOfComments").append(numCommentsSection);

                       console.log(data);
                       
                   },
                   error: function (error) {
                       console.log(error);
                   }
               })

        }
         async function getNumberOfComments() {
                
             const postId = '@Model.Id';
        
              
               var  Post = {};
               Post.Id = postId;
            
               var result = await $.ajax({
                   type: 'POST',
                   url: '@Url.Action("getReplies")',
                   data: '{Post: ' + JSON.stringify(Post) + '}',
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                   success: function (data) {
                           number = data.length;
                      
                       
                   },
                   error: function (error) {
                       console.log(error);
                   }
               })

               
        }

         setInterval(async function () {
                await getNumberOfComments();
                if (number != NumOfComments) {
                    NumOfComments = number;
                    LoadComments();
                    console.log("smth to change");
                }else console.log("nothing to change")
            },5000)
    </script>
</section>


<!-- Blog Details Section End -->
